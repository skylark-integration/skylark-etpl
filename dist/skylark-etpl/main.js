/**
 * skylark-etpl - A version of etpl.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-etpl/
 * @license MIT
 */
define(["skylark-langx/skylark"],function(t){function e(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function n(){this.raw=[],this.length=0}n.prototype={push:function(t){this.raw[this.length++]=t},pop:function(){if(this.length>0){var t=this.raw[--this.length];return this.raw.length=this.length,t}},top:function(){return this.raw[this.length-1]},bottom:function(){return this.raw[0]},find:function(t){for(var e=this.length;e--;){var n=this.raw[e];if(t(n))return n}}};var r=178245;function i(){return"___"+r++}function o(t,n){var r=t.prototype,i=new Function;i.prototype=n.prototype,t.prototype=new i,t.prototype.constructor=t,e(t.prototype,r)}var s={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};function a(t){return s[t]}var p={html:function(t){return t.replace(/[&<>"']/g,a)},url:encodeURIComponent,raw:function(t){return t}};function h(t){return'"'+t.replace(/\x5C/g,"\\\\").replace(/"/g,'\\"').replace(/\x0A/g,"\\n").replace(/\x09/g,"\\t").replace(/\x0D/g,"\\r")+'"'}function c(t){return t.replace(/[\^\[\]\$\(\)\{\}\?\*\.\+]/g,function(t){return"\\"+t})}function l(t){var e=arguments;return t.replace(/\{([0-9]+)\}/g,function(t,n){return e[n-0+1]})}var u='var r="";',f="r+=",d=";",g="return r;",y="undefined"!=typeof navigator&&navigator.userAgent.match(/msie\s*([0-9]+)/i);function v(t,e,n,r,i,o){for(var s=n.length,a=t.split(e),p=0,h=[],c=0,l=a.length;c<l;c++){var u=a[c];if(c){var f=1;for(p++;;){var d=u.indexOf(n);if(d<0){h.push(p>1&&f?e:"",u);break}if(p=r?p-1:0,h.push(p>0&&f?e:"",u.slice(0,d),p>0?n:""),u=u.slice(d+s),f=0,0===p)break}0===p&&(i(h.join("")),o(u),h=[])}else u&&o(u)}p>0&&h.length>0&&(o(e),o(h.join("")))}function m(t,e,n){var r,i=[],o=e.options,s="",a="",p="",c="";return n&&(s="ts(",a=")",p=f,c=d,r=o.defaultFilter),v(t,o.variableOpen,o.variableClose,1,function(t){n&&t.indexOf("|")<0&&r&&(t+="|"+r);var o,u=t.indexOf("|"),f=(u>0?t.slice(0,u):t).replace(/^\s+/,"").replace(/\s+$/,""),d=u>0?t.slice(u+1):"",g=0===f.indexOf("*"),y=[g?"":s,(o=f,l('gv({0},["{1}"])',h(o=o.replace(/^\s*\*/,"")),o.replace(/\[['"]?([^'"]+)['"]?\]/g,function(t,e){return"."+e}).split(".").join('","'))),g?"":a];if(d)for(var v=(d=m(d,e)).split("|"),w=0,b=v.length;w<b;w++){var x=v[w].match(/^\s*([a-z0-9_-]+)(\((.*)\))?\s*$/i);x&&(y.unshift('fs["'+x[1]+'"]('),x[3]&&y.push(",",x[3]),y.push(")"))}i.push(p,y.join(""),c)},function(t){i.push(p,n?h(t):t,c)}),i.join("")}function w(t,e){this.value=t,this.engine=e}function b(t,e){this.value=t,this.engine=e,this.children=[],this.cloneProps=[]}function x(t,e){var n=t.stack,r=e?n.find(function(t){return t instanceof e}):n.bottom();if(r){for(var i;(i=n.top())!==r;){if(!i.autoClose)throw new Error(i.type+" must be closed manually: "+i.value);i.autoClose(t)}r.close(t)}return r}y&&y[1]-0<8&&(u="var r=[],ri=0;",f="r[ri++]=",g='return r.join("");'),w.prototype={getRendererBody:function(){var t=this.value,e=this.engine.options;return!t||e.strip&&/^\s*$/.test(t)?"":m(t,this.engine,1)},clone:function(){return this}},b.prototype={addChild:function(t){this.children.push(t)},open:function(t){var e=t.stack.top();e&&e.addChild(this),t.stack.push(this)},close:function(t){t.stack.top()===this&&t.stack.pop()},getRendererBody:function(){for(var t=[],e=this.children,n=0;n<e.length;n++)t.push(e[n].getRendererBody());return t.join("")},clone:function(){for(var t=new(0,this.constructor)(this.value,this.engine),e=0,n=this.children.length;e<n;e++)t.addChild(this.children[e].clone());for(e=0,n=this.cloneProps.length;e<n;e++){var r=this.cloneProps[e];t[r]=this[r]}return t}};var k='data=data||{};var v={},fs=engine.filters,hg=typeof data.get=="function",gv=function(n,ps){var p=ps[0],d=v[p];if(d==null){if(hg){return data.get(n);}d=data[p];}for(var i=1,l=ps.length;i<l;i++)if(d!=null)d = d[ps[i]];return d;},ts=function(s){if(typeof s==="string"){return s;}if(s==null){s="";}return ""+s;};';function R(t,e){var n=t.match(/^\s*([a-z0-9\/\._-]+)\s*(\(\s*master\s*=\s*([a-z0-9\/\._-]+)\s*\))?\s*/i);if(!n)throw new Error("Invalid "+this.type+" syntax: "+t);this.master=n[3],this.name=n[1],b.call(this,t,e),this.blocks={}}function C(t,e){var n=t.match(/^\s*([a-z0-9\/\._-]+)\s*$/i);if(!n)throw new Error("Invalid "+this.type+" syntax: "+t);this.name=n[1],b.call(this,t,e),this.cloneProps=["name"]}function E(t,e){var n=t.match(/^\s*([a-z0-9\/\._-]+)\s*$/i);if(!n)throw new Error("Invalid "+this.type+" syntax: "+t);this.name=n[1],b.call(this,t,e),this.cloneProps=["name","state","blocks","target"],this.blocks={}}function _(t,e){var n=t.match(/^\s*([a-z0-9_]+)\s*=([\s\S]*)$/i);if(!n)throw new Error("Invalid "+this.type+" syntax: "+t);this.name=n[1],this.expr=n[2],b.call(this,t,e),this.cloneProps=["name","expr"]}function B(t,e){var n=t.match(/^\s*([a-z0-9_-]+)\s*(\(([\s\S]*)\))?\s*$/i);if(!n)throw new Error("Invalid "+this.type+" syntax: "+t);this.name=n[1],this.args=n[3],b.call(this,t,e),this.cloneProps=["name","args"]}function T(t,e){var n=t.match(/^\s*([a-z0-9\/\._-]+)\s*(\(([\s\S]*)\))?\s*$/i);if(!n)throw new Error("Invalid "+this.type+" syntax: "+t);this.name=n[1],this.args=n[3],b.call(this,t,e),this.cloneProps=["name","args"]}function S(t,e){var n=new RegExp(l("^\\s*({0}[\\s\\S]+{1})\\s+as\\s+{0}([0-9a-z_]+){1}\\s*(,\\s*{0}([0-9a-z_]+){1})?\\s*$",c(e.options.variableOpen),c(e.options.variableClose)),"i"),r=t.match(n);if(!r)throw new Error("Invalid "+this.type+" syntax: "+t);this.list=r[1],this.item=r[2],this.index=r[4],b.call(this,t,e),this.cloneProps=["list","item","index"]}function z(t,e){b.call(this,t,e)}function O(t,e){z.call(this,t,e)}function P(t,e){b.call(this,t,e)}o(R,b),o(C,b),o(E,b),o(_,b),o(B,b),o(T,b),o(S,b),o(z,b),o(O,z),o(P,z),R.prototype.init=function(t){this.master&&(t.deps[this.master]=!0)},T.prototype.init=E.prototype.init=function(t){t.deps[this.name]=!0};var $=1,I=2,j=3,A=4;function F(t,e,n){t.commandTypes[e]=n,n.prototype.type=e}function M(t){this.options={commandOpen:"\x3c!--",commandClose:"--\x3e",commandSyntax:/^\s*(\/)?([a-z]*)\s*(?::([\s\S]*))?$/,variableOpen:"${",variableClose:"}",defaultFilter:"html"},this.commandTypes={},F(this,"target",R),F(this,"block",C),F(this,"import",E),F(this,"use",T),F(this,"var",_),F(this,"for",S),F(this,"if",z),F(this,"elif",O),F(this,"else",P),F(this,"filter",B),this.config(t),this.targets={},this.filters=e({},p)}function L(t,e){var r,i=e.options.commandOpen,o=e.options.commandClose,s=e.options.commandSyntax,a=new n,p={engine:e,targets:[],stack:a,target:null,deps:{}},h=[];function c(){var t;if(h.length>0&&(t=h.join(""))){var n=new w(t,e);n.beforeAdd(p),a.top().addChild(n),h=[],e.options.strip&&p.current instanceof b&&(n.value=t.replace(/^[\x20\t\r]*\n/,"")),p.current=n}}v(t,i,o,0,function(t){var n,a=s.exec(t);if(a&&(n=a[2]||"target")&&(r=e.commandTypes[n.toLowerCase()])&&"function"==typeof r){c();var l=p.current;e.options.strip&&l instanceof w&&(l.value=l.value.replace(/\r?\n[\x20\t]*$/,"\n")),a[1]?l=x(p,r):("function"==typeof(l=new r(a[3],e)).init&&l.init(p),l.beforeOpen(p),l.open(p)),p.current=l}else/^\s*\/\//.test(t)||h.push(i,t,o);r=null},function(t){h.push(t)}),c(),x(p);var l=[];for(var u in p.deps)l.push(u);return{targets:p.targets,deps:l}}E.prototype.applyMaster=R.prototype.applyMaster=function(t){if(this.state>=j)return 1;var e=this.blocks;var n=this.engine.targets[t];if(n){if(n.applyMaster(n.master))return this.children=n.clone().children,function t(n){var r=n.children;if(r instanceof Array)for(var i=0,o=r.length;i<o;i++){var s=r[i];s instanceof C&&e[s.name]&&(s=r[i]=e[s.name]),t(s)}}(this),this.state=j,1}else if("error"===this.engine.options.missTarget)throw new Error("[ETPL_MISS_TARGET]"+t+", when extended by "+(this.target?this.target.name:this.name))},R.prototype.isReady=function(){if(this.state>=A)return 1;var t=this.engine,e=this.name,n=1;return this.applyMaster(this.master)?(function r(i){for(var o=0,s=i.children.length;o<s;o++){var a=i.children[o];if(a instanceof E){var p=t.targets[a.name];if(!p&&"error"===t.options.missTarget)throw new Error("[ETPL_MISS_TARGET]"+a.name+", when imported by "+e);n=n&&p&&p.isReady(t)}else a instanceof b&&r(a)}}(this),n&&(this.state=A),n):void 0},R.prototype.getRenderer=function(){if(this.renderer)return this.renderer;if(this.isReady()){var t=new Function("data","engine",[k,u,this.getRendererBody(),g].join("\n")),e=this.engine;return this.renderer=function(n){return t(n,e)},this.renderer}return null},R.prototype.open=function(t){x(t),b.prototype.open.call(this,t),this.state=$,function(t,e){e.target=t;var n=e.engine,r=t.name;if(n.targets[r])switch(n.options.namingConflict){case"override":n.targets[r]=t,e.targets.push(r);case"ignore":break;default:throw new Error("[ETPL_TARGET_EXISTS]"+r)}else n.targets[r]=t,e.targets.push(r)}(this,t)},_.prototype.open=T.prototype.open=function(t){t.stack.top().addChild(this)},C.prototype.open=function(t){b.prototype.open.call(this,t),t.stack.find(function(t){return t.blocks}).blocks[this.name]=this},O.prototype.open=function(t){(new P).open(t),x(t,z).addChild(this),t.stack.push(this)},P.prototype.open=function(t){x(t,z).addChild(this),t.stack.push(this)},E.prototype.open=function(t){this.parent=t.stack.top(),this.target=t.target,b.prototype.open.call(this,t),this.state=$},T.prototype.close=_.prototype.close=function(){},E.prototype.close=function(t){b.prototype.close.call(this,t),this.state=I},R.prototype.close=function(t){b.prototype.close.call(this,t),this.state=this.master?I:j,t.target=null},E.prototype.autoClose=function(t){var e=this.parent.children;for(var n in e.push.apply(e,this.children),this.children.length=0,this.blocks)this.target.blocks[n]=this.blocks[n];this.blocks={},this.close(t)},b.prototype.beforeOpen=w.prototype.beforeAdd=function(t){t.stack.bottom()||new R(i(),t.engine).open(t)},R.prototype.beforeOpen=function(){},E.prototype.getRendererBody=function(){return this.applyMaster(this.name),b.prototype.getRendererBody.call(this)},T.prototype.getRendererBody=function(){return l("{0}engine.render({2},{{3}}){1}",f,d,h(this.name),m(this.args,this.engine).replace(/(^|,)\s*([a-z0-9_]+)\s*=/gi,function(t,e,n){return(e||"")+h(n)+":"}))},_.prototype.getRendererBody=function(){return this.expr?l("v[{0}]={1};",h(this.name),m(this.expr,this.engine)):""},z.prototype.getRendererBody=function(){return l("if({0}){{1}}",m(this.value,this.engine),b.prototype.getRendererBody.call(this))},P.prototype.getRendererBody=function(){return l("}else{{0}",b.prototype.getRendererBody.call(this))},S.prototype.getRendererBody=function(){return l('var {0}={1};if({0} instanceof Array)for (var {4}=0,{5}={0}.length;{4}<{5};{4}++){v[{2}]={4};v[{3}]={0}[{4}];{6}}else if(typeof {0}==="object")for(var {4} in {0}){v[{2}]={4};v[{3}]={0}[{4}];{6}}',i(),m(this.list,this.engine),h(this.index||i()),h(this.item),i(),i(),b.prototype.getRendererBody.call(this))},B.prototype.getRendererBody=function(){var t=this.args;return l("{2}fs[{5}]((function(){{0}{4}{1}})(){6}){3}",u,g,f,d,b.prototype.getRendererBody.call(this),h(this.name),t?","+m(t,this.engine):"")},M.prototype.config=function(t){e(this.options,t)},M.prototype.compile=M.prototype.parse=function(t){var e=new Function('return ""');if(t){var n=L(t,this).targets;n.length&&(e=this.targets[n[0]].getRenderer())}return e},M.prototype.getRenderer=function(t){var e=this.targets[t];if(e)return e.getRenderer()},M.prototype.render=function(t,e){var n=this.getRenderer(t);return n?n(e):""},M.prototype.addCommand=function(t,e){var n=e;"function"!=typeof n&&((n=function(t,e){b.call(this,t,e)}).prototype=e),o(n,b),F(this,t,n)},M.prototype.addFilter=function(t,e){"function"==typeof e&&(this.filters[t]=e)};var G=new M;return G.Engine=M,G.version="3.2.0",G.Command=b,G.util={inherits:o,stringFormat:l,stringLiteralize:h,compileVariable:m,parseSource:L},t.attach("intg.templating.etpl",G)});
//# sourceMappingURL=sourcemaps/main.js.map
